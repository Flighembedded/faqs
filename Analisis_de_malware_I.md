**FAQ:**    **Análisis de malware**
**Realizado gracias a la colaboración de todos los miembros de** [**Indetectables.net**](http://www.indetectables.net/)

**Pendiente:** Desempaquetado manual (Ollydbg), análisis de strings hexadecimal, profundizar en VM

**¿Que es Malware?**

Dentro del término malware se engloba a todo tipo de programas destinos al robo de información, control remoto del sistema o cualquier otra acción malevola llevaba a cabo sin el consentimiento del usuario. Se le denomina programa maligno o malware por sus habituales características destructivas.

**Tipos de Malware**
 Hay muchos tipos de malware, esencialmente se pueden distinguir los siguientes:

**Virus:** Un virus es un programa parásito que se añade a si mismo a otro programa con el fin de infectar o añadir una función no deseada. Los virus puede ser de gran capacidad destructiva de acuerdo a su clasificación. Algunos son fáciles de detectar y otros difíciles tanto de detectar como de remover. Algunos virus usan polimorfismo (cambian de forma) para mutar a nuevas formas y prolongar su estancia mientras son detectados. Un virus requiere la asistencia del usuario para poder ser ejecutado, por lo que se valen de engaños para hacer creer al usuario que ejecuta un programa inofensivo.

**Troyanos:** Un troyano es un software maligno que realiza acciones de control del sistema del usuario comprometido, dándole al atacante el control total sobre la máquina. Como su nombre indica, los troyanos suelen alcanzar el sistema embebidos dentro de algún otro software.

**Gusanos:** Un gusano es un virus con capacidad de propagarse a si mismo, estos no requieren en parte de la interacción del usuario para propagarse por todo el sistema. En los últimos años no han sido muy comunes, pero aun se usan para otros fines como distribuir troyanos y otras formas de malware en dispositivos como USB, CDs o software en la red.

**Spyware/Adware: ** Los Spywares y adwares se describen como una clase de software que es instalado sin el consentimiento del usuario con el fin de reportar los comportamientos del usuario al atacante. El atacante en este caso se vale del malware para anunciar productos, reportar fallos o mostrar falsas alarmas sobre seguridad al usuario, para que este descargue algun tipo de contenido malicioso a su maquina. A pesar de lo evidentes que son estas alertas, el usuario cae y da paso a más malware como keyloggers, capturadores de datos personales, etc. Por lo que se les considera de alta peligrosidad.

**Rootkit:** La definición de &quot;rootkit&quot; ha evolucionado, hoy en día se refiere a una categoría de software que se oculta a si mismo. Un rootkit es una herramienta, o un grupo de herramientas que tiene por finalidad esconderse a sí misma en el sistema operativo y esconder a otros programas, procesos, archivos, directorios, llaves de registro, y/o puertos. Se usan habitualmente para asegurar a un intruso seguir accediendo a un sistema una vez que ha conseguido entrar por primera vez.

**Análisis inicial del malware**

**Analizadores recomendados para Windows**
Ya que un malware puede tener multitud de comportamientos, es recomendado usar una aplicación que integre y registre todas estas acciones. Entre muchas que hay disponibles como las tools de sysinternals e iDefense, la recomendada es esta:
[**SysAnalizer**](http://labs.idefense.com/software/download/?downloadID=15) **:** Integra sniffer de conexiones, seguimiento a APIs, procesos y cambios en el registro. La herramienta completa para tener toda la información ![](RackMultipart20200709-4-zh4e8q_html_d9e8b12dd6eca6a4.jpg)
 Al iniciar el análisis con esta herramienta, nos guiaran paso por paso por la información generada de forma muy visual con la opcion de ver con detalles de primera mano las acciones del malware en el equipo. Información como procesos activos, puertos activos, DLLs procesadas, drivers cargados, registro de cambios en el regedit, archivos y APIS son lo que tendremos a disposición para conocer los comportamientos del malware. ![](RackMultipart20200709-4-zh4e8q_html_16c14a22d906fcf6.jpg)

**ANÁLISIS SELECTIVO DE COMPORTAMIENTO DE MALWARE
 Se puede hacer análisis individuales según lo que queramos saber sobre el malware,
 para esto existen otro multitud de herramientas útiles las cuales veremos a continuación:**

| **Analizando el tipo de protección malware:
 La primera cosa que se debe saber es determinar que tipo de archivo es el malware. Herramientas como**[**PEiD**](http://www.peid.info/files/PEiD-0.95-20081103.zip)**,**[**QuickUnpack**](http://rapidshare.com/files/38006670/quickunpack101.zip)**o**[**RGD Packer detector**](http://www.egrupos.net/grupo/rdgsoft/ficheros/3/verFichero/29/RDG%20Packer%20Detector%20v0.6.6%202k8.rar)**son muy utiles para saber si el archivo posee algún tipo de encriptación, protección o modificación. Esta herramienta posee firmas que detectan el tipo de empaquetado y proveen una interfaz sencilla para desempaquetarlo. En caso de no poder hacerlo con estas herramientas se puede recurrir a un desempaquetado manual más complejo usando un debugger para ver como se comporta la herramienta y desempacarla (**[**OllyDbg**](http://www.ollydbg.de/odbg110.zip)**,**[**IDA Pro**](http://85.17.92.154/files/idafree49.exe)**, etc). **| PEiD v0.94**![](RackMultipart20200709-4-zh4e8q_html_84d1fac4e40c6b0b.png)**

 |
| --- | --- |
| **Analizando procesos activos:**
El malware al ser ejecutado puede lanzar varios procesos, es útil saber que esta ejecutándose para identificar los procesos nuevos que se generan y así saber cual es el que realiza acciones malignas, pues en ocasiones el malware emplea suplantación de procesos del sistema para pasar desapercibido. Herramientas como [Process Explorer](http://download.sysinternals.com/Files/ProcessExplorer.zip) de [sysinternals](http://technet.microsoft.com/en-us/sysinternals/default.aspx), Process Analyzer permite de forma visual ver los procesos activos en el sistema e identificar por firmas cual de ellos es maligno y así poder finalizarlo o analizarlo a fondo.
 Estas herramientas dumpean la memoria en búsqueda de nuevos cambios e identifican rápidamente los procesos creados al ejecutar malware basándose en una base de firmas preconfiguradas, esto con el fin de diferenciar los procesos del sistema de otros que actúen como suplantadores de los mismos. | Process Analyzer de [iDefense Labs](http://labs.idefense.com/) **![](RackMultipart20200709-4-zh4e8q_html_edc61909687db4f7.jpg)** |
 |
| **Analizando llamadas a APIs del sistema:**
 Un malware puede ser identificado según las llamadas que haga a las APIs del sistema, de esta forma se puede establecer que usos o comportamientos hace valiéndose de los recursos de otros programas o del mismo sistema. Las llamadas a APIs a diferencia de los procesos pueden pasar desapercibidas fácilmente ya que son llamadas a .dlls o procedimientos inyectados en las mismas. Herramientas como API Logger (incluida en [SysAnalizer](http://labs.idefense.com/software/download/?downloadID=15) ) permiten tener una información completa sobre este tipo de comportamientos e identificar malware fácilmente.
 En caso de encontrar llamadas a APIs sospechosas podremos identificar con claridad que objetos o procedimientos se invocan en las mismas (muy usual en métodos de inyección) | ApiLogger de iDefense Labs ![](RackMultipart20200709-4-zh4e8q_html_4676639e731e5087.jpg) |
 |
| **Analizando cambios en archivos:
 Se puede tener claridad de los cambios que genera un malware al ser ejecutado llevando un registro de los archivos que son modificados después que el mismo se ejecute. Herramientas como**[**FileMon**](http://technet.microsoft.com/en-us/sysinternals/bb896642.aspx)**son una forma fácil para encontrar cambios en el sistema. Adicionalmente se puede conocer las búsquedas que hace el malware en carpetas y directorios. En ocasiones el malware esta programado para hacer los cambios no inmediatamente sino después de cierto tiempo, por lo que es indispensable mantener un registro completo de actividades desde el momento de ejecución del malware hasta el momento de cierre del sistema para conocer todos los cambios. **|** FileMon de sysinternals ![](RackMultipart20200709-4-zh4e8q_html_53671b882f8bd6a6.jpg)** |
 |
| **Analizando strings del programa
 Un string es una cadena de texto, analizar las cadenas de texto que sean visibles en un programa nos puede dar una idea de su funcionamiento. Para esto podemos usar un editor hexadecimal como**[**HxD**](http://mh-nexus.de/en/downloads.php?product=HxD)**o un programa que extraiga los strings de la aplicación, como el**[**Strings**](http://technet.microsoft.com/en-us/sysinternals/bb897439.aspx)**de sysinternals y tener rápidamente conocimiento sobre el contenido del programa. En caso que el programa este protegido/encriptado no podremos tener una imagen clara de los strings, por lo que necesitaremos desempaquetarlo o desprotegerlo para poder verlos legibles.** | ![](RackMultipart20200709-4-zh4e8q_html_74086f16eaad2a0.jpg) |
 |

| **Analizando movimientos en el registro:**
[**Regshot**](http://downloads.sourceforge.net/regshot/regshot_1.8.2_src_bin.zip?modtime=1194107176&amp;amp;big_mirror=0) **es una aplicación de código abierto, muy ligera y que cumple bastante bien su objetivo en tan solo unos cuantos minutos, además no requiere instalación. No solamente se limita a verificar cambios dentro del registro de Windows, también es capaz de verificar los cambios realizados dentro de alguna carpeta del sistema. Así podemos observar que valores se han agregado al registro, cuales claves fueron modificadas, archivos agregados junto con su ruta y que atributos de archivos han sido modificados.** | **Regshot 1.8.2 ![](RackMultipart20200709-4-zh4e8q_html_c96d408e87731cf8.jpg)** | **Reporte de cambios generados en registro ![](RackMultipart20200709-4-zh4e8q_html_732e56b03e3df28d.jpg)**

 |
| --- | --- | --- |

| **Analizando conexiones activas:**
Es de gran utilidad conocer que conexiones se despliegan al ejecutar un malware, estos como en el caso de troyanos conectan a alguna dirección IP o puerto una vez se han ejecutado, así que teniendo un registro completo de nuestras conexiones y que procesos generan dichas conexiones TCP o UDP podremos identificar rápidamente una posible amenaza o intento de conexión. Herramientas como Active Ports o un simple netstat nos pueden ayudar en dicho fin. Otra programa que podemos usar es [TCPView](http://technet.microsoft.com/en-us/sysinternals/bb897437.aspx) de sysinternals. | Active Ports de Sysinternals **![](RackMultipart20200709-4-zh4e8q_html_9b7dfc3393e5ec10.jpg)** |
 |
| --- | --- | --- |
| **Analizando trafico generado por conexiones:**  **En ocasiones no basta con saber a que puertos conecta un malware para identificar su comportamiento, por lo que se puede recurrir a sniffear el trafico que se genera en dichas conexiones y saber que información se esta enviando según los paquetes que se capturen en la comunicación. Muchos sniffers como** [**wireshark**](http://www.wireshark.org/download.html) **permiten tener una información, pero identificar de que proceso sale la conexión facilita aun más la tarea, pues nos permite saber que tipo de malware es, a que IPs se conecta y demás. Aplicaciones como SnifHit nos dan información completa sobre las mismas.

 En el caso de IRCbots por ejemplo, podremos saber a que canal conecta, que comandos envía y toda esta información sera detallada. O en caso de conexiones UDP difíciles de sniffear tendremos los mismos resultados.**
   | **Sniff Hit de iDefense Labs ![](RackMultipart20200709-4-zh4e8q_html_a35772c319d5834d.jpg)** |
 |
| **Analizando autoinicios en el sistema:**  **Una de las principales características del malware es su persistencia y tiempo de vida después de reiniciar la maquina. El malware se vale de entradas en el registro de Windows para iniciarse cada vez que el usuario inicie sesión en el equipo. Identificar los elementos de autoinicio y su localización en el registro ayuda para poder llegar a una solución para desinfectar la maquina. Estas entradas pueden estar en varios sectores como Run, RunOnce, ActiveX entre otros. Herramientas como** [**Autoruns**](http://technet.microsoft.com/en-us/sysinternals/bb963902.aspx) **nos permiten tener un informe completo acerca de dichas entradas y generar una solución rápida eliminándolas.** | **Autoruns de sysinternals ![](RackMultipart20200709-4-zh4e8q_html_b36dbf1d1c965738.jpg)** |
 |
| **Análisis de rootkits**
**Ya que los rootkits trabajan de una manera diferente al malware común, se necesitan herramientas especializadas para detectar los hooks, modificaciones en la tabla de servicios (SSDT) y detección de códigos ocultos.** [**Rootkit Unhooker LE (RkU)**](http://forum.sysinternals.com/uploads/20071210_182632_rku37300509.rar) **es una utilidad avanzada de detección y eliminación de rootkits, esta permite tener una visión avanzada de las tablas de servicio, stealth code, hooks en drivers, librerías, IAT/EAT, DKOH, IRP, ejecuciones en kernel y demás métodos que usan los rootkits para alojarse en un sistema. En su modo &quot;reporte&quot; hace un listado completo del análisis de todos estos elementos, filtrando así los posibles hooks sospechosos o rootkits.** | ![](RackMultipart20200709-4-zh4e8q_html_5d0850fc94e749be.png) |

**Análisis de malware online
 Existen varios sitios en la red que permiten al usuario saber a ciencia cierta los comportamientos de un archivo al ser ejecutado sin comprometer la seguridad de su maquina. Estos generan un log completo que da una idea del comportamiento del malware al ser ejecutado. Aunque no son del todo certeros pues algunos malwares defensivos implementan la detección de entornos virtualizados, por lo que no ejecutan a totalidad sus funciones cuando son analizados por este tipo de herramientas.**

| **Análisis usando CWSandbox ![](RackMultipart20200709-4-zh4e8q_html_c0b420e8c740e7dd.png)****[**[**Analizar archivo con CWSandbox**](http://www.cwsandbox.org/?page=submit&amp;amp;action=verify)**] **|** Análisis usando Anubis ![](RackMultipart20200709-4-zh4e8q_html_b797118bd91fbb1b.png)****[** [**Analizar archivo con Anubis**](http://analysis.seclab.tuwien.ac.at/) **]** | **Análisis usando Sunbelt ![](RackMultipart20200709-4-zh4e8q_html_61bac842369c0219.png)
 [**[**Analizar archivo con Sandbox**](http://research.sunbelt-software.com/Submit.aspx)**] **|** Análisis usando ThreatExpert ![](RackMultipart20200709-4-zh4e8q_html_f20e8149c0b7f64c.png)**
[**[Analizar archivo con ThreatExpert**](http://www.threatexpert.com/submit.aspx) **]** |
| --- | --- | --- | --- |