[![](RackMultipart20200709-4-zepeq6_html_33a4074988119b99.png)](http://indetectables.net/foro/index.php)

**FAQ: Analisis de Malware II  **![](RackMultipart20200709-4-zepeq6_html_9b246c9b3c27014b.png)**(Editando!)**
TEMAS PENDIENTES A TERMINAR
 1) Instalacion de nepenthes y zerowine ![](RackMultipart20200709-4-zepeq6_html_33a4074988119b99.png) ![](RackMultipart20200709-4-zepeq6_html_33a4074988119b99.png) (Solo explique uso, hay otros manuales que lo explican mejor)
 2) Configuracion de interfaz de red linux para maquinas virtuales (subredes trampa, puentes a eth0, modificar /hosts)
3) .... y lo que surja de aqui en adelante.

**Análisis en entorno seguro:**
Se recomienda hacer todas estas pruebas en un entorno virtualizado como [VirtualPC](http://www.microsoft.com/downloads/details.aspx?displaylang=es&amp;amp;FamilyID=04d26402-3199-48a3-afa2-2dc0b40a73b6), VMware, etc. Estas herramientas permiten que usted interactue con el malware sin la necesidad de reconstruir el sistema en caso de fallos graves, restaurando inmediatamente el sistema virtualizado a su configuración original. Si un malware real infecta un entorno virtualizado no habrán daños o consecuencias al sistema principal. Se recomienda también configurar la maquina virtual para que no tenga salida a internet o contacto en red con la maquina real. Configurando un entorno de esta manera se puede mirar con seguridad todas las funciones del malware al ejecutarse y evitar asi problemas serios. VMware y otros entornos virtuales ofrecen la simulación de múltiples computadores corriendo sobre un mismo sistema, por lo que puede también simular varios sistemas operativos y ver las diferencias entre ellos cuando el malware es ejecutado.

 **Creando un mini-laboratorio en LINUX**&quot;La mejor forma de asegurar una puerta es dejarla abierta&quot;, a esto me refiero para aplicarlo al analisis de malware. LINUX en este caso es nuestra puerta abierta, pues si queremos analizar virus que funcionan en Windows, debemos trabajar en otra plataforma para no vernos afectados directamente en caso que nuestra plataforma virtual falle ante alguna vulnerabilidad que explote la aplicacion que estamos ejecutando. Esto nos permite darle total libertad al malware para que haga de las suyas, le crearemos un entorno en el que se pueda ejecutar de forma segura y no nos perjudique nuestro sistema de pruebas.

 Vamos a ver todos los elementos poco a poco, por ahora veamos un esquema general del sistema al cual queremos llegar:

![](RackMultipart20200709-4-zepeq6_html_4a9a139b78687bc4.png)

**Asegurando la red**
Si necesitamos analizar el trafico que hace una aplicacion hacia internet podriamos recurrir a sniffarlo, mas seria una medida insegura ya que tendriamos que generar trafico como minimo. Un FIREWALL como lo conocemos podria ser util para restringir el trafico, pero lo que necesitamos es habilitar el trafico, pero teniendo un control sobre el.
 Usaremos entonces algo llamado **HONEYWALL,** este **captura** los puertos (inicia una conexion listening para capturar el trafico que pase sobre ellos), de esta forma el trafico no va directamente a internet sino al honeywall, que lo filtra y captura clasificandolo segun su actividad.
 Usaremos como honeywall uno llamado NEPENTHES, este captura los puertos a espera de conexiones y trae predefinida una gran base de configuraciones y acciones avanzadas que pueda detectar como shellcodes, ircbots, etc.

 **Usando Nepenthes como honeypot/honeywall** Mas informacion: http://nepenthes.carnivore.it/
 http://www.securityfocus.com/infocus/1880
 Nepenthes es un honeypot/honeywall que permite emular servicios vulnerables y capturar el trafico de sus puertos para poder obtener informacion sobre lo que intente atacarlo (sea por metodos de spreading, conectandose a algun sitio, explotando un fallo en el servicio... nepenthes cubre muchiisimas cosas, entre ellas una gran variedad de bots, shellcodes, exploits, ms-0days tales como  Agobot, Phatbot, Sdbot, etc.

![](RackMultipart20200709-4-zepeq6_html_a2af11018079f5a1.png)

 **¿Para que abrir tantos puertos?**
  El malware no siempre sera la tipica forma de ejecucion, sino que tambien se puede valer de otros recursos como spreading, toma de servicios o conexiones locales usando shellcodes, 0days y demas vulnerabilidades. Si creamos un sistema emulado (honeypot) en donde le otorgamos al malware todos esos servicios &#39;vulnerables&#39;, sera mas facil identificar que haria en caso de ejecutarse en una maquina real. veamos por ejemplo
 como puede filtrar un honeypot cualquier amenaza que se le programe.

![](RackMultipart20200709-4-zepeq6_html_f2289a0fac9590b4.png)

**Otras funciones de nepenthes**
 Este puede ser configurado para que envie los archivos .exe que ejecutemos o descarguemos directamente al sitio de analisis de norman sandbox y mostrarnos el reporte, tambien cuenta con una red abierta de analisis en la que puedes recibir muestras de otros nepenthes o enviar las tuyas a algun nepenthes de la red. Esto facilitaria las cosas si quisieramos atrapar el malware y analizarlo directamente acelerando asi su deteccion.
 La configuracion de los scripts es abierta y podemos establecer una direccion e-mail en la cual recibir los reportes, o bien desactivar esa opcion y trabajar solo en local sin distribuir las muestras.

**ANALISIS DE MALWARE EN LINUX**
 Sabemos que en LINUX la extension .EXE no es ejecutable, usaremos entonces una herramienta llamada **WINE** para poder emular la ejecucion de los .EXEs como si estuvieran en Windows, pero con la gran ventaja de no tener que virtualizar el sistema operativo. ¿Todo esto para que? Los metodos que detectan maquinas virtuales estarian obsoletos ante WINE y podriamos aprovechar la puerta abierta para analizarlo.

**Usando WINE para ejecutar aplicaciones WIN 16/32 (EXE,COM,BAT)**
Mas informacion: http://www.winehq.org/

![](RackMultipart20200709-4-zepeq6_html_5937c21bac6de90d.png)

**Usando Zerowine para analizar los metodos ANTI que posea un archivo:**
Mas informacion: http://sourceforge.net/projects/zerowine/
 Algunos requisitos minimos:
 \* Tener instalado WINE en su ultima actualizacion 1.1.13 (synapse ayuda en eso, o desde la web oficial).
 \* Tener python como IDE (Ubuntu lo trae por defecto asi que no problem), ademas de eso tener la libreria pefile-1.2.10 (para analizar las propiedades del .exe malware) y python-ptrace (para dumpear el proceso) instaladas correctamente.
 \* Instalar ZEROWINE, otorgarle permisos de ejecucion a los archivos .py que se crean tras la instalacion de zerowine.
 \* Configurar el fichero en cgi-bin/config.py con las rutas que vaya a manejar para los archivos. Configurar ademas el puerto en donde correra el framework y la IP que le vamos a asignar.

**¿Zerowine como source o como imagen para QEMU?**
 Podemos tomar el source del zerowine y ponerlo en marcha, o descargarnos una imagen (.img) para QEMU con todos los ingredientes ya preparados.
 Obviamente si elejimos la opcion de la imagen no tendremos que tener nada especial instalado, solamente el QEMU, ya que lo que haremos sera uniciar un
 virtual a partir del archivo .img. Miremos como podriamos arrancar una imagen usando QEMU: ![](RackMultipart20200709-4-zepeq6_html_3e7a8041736d52c4.png)
 Una vez iniciemos tendremos abierto el puerto 8000 donde trabaja Zerowine y recibe nuestros datos. Bastaria acceder a 127.0.0.1:8000 para trabajar en el. ![](RackMultipart20200709-4-zepeq6_html_152c297f578eb09b.png)

**Resultados de zerowine:**
Tomaremos primero un analisis con zerowine antes de someter al archivo a la virtualizacion
 en nuestra maquina virtual, asi sabremos si dispone de alguna defensa especial que nos dificulte el camino. ![](RackMultipart20200709-4-zepeq6_html_a787e443ef112ef0.png)
**Analisis de dumpeo del proceso con zerowine**
Si elejimos la opcion de dumpear proceso, zerowine nos brindara un log con detalles avanzados sobre la ejecucion de este archivo,
 Miremos por ejemplo un log en donde podemos identificar claramente que se crea un nuevo archivo en temp llamado asd.exe

![](RackMultipart20200709-4-zepeq6_html_5e01cda22a881902.png)

**Maquinas virtuales y LINUX:**
**Mas informacion:** http://rchicangana.blogspot.com/2008/07/virtualbox-16-en-hardy-heron.html
Hay una serie de aplicaciones que podemos usar, entre ellas QEMU, VIRTUALBOX, VMWARE, VIRTUAL PC, etc.No todas presta compatibilidad completa con linux, dependen de la version del kernel que tengamos instalado. Usaremos **VirtualBox OSE** (Open Source Edition) por ser la mas compatible para este entorno y poseer la mayor gama de paquetes compatibles con diferentes kernels. **![](RackMultipart20200709-4-zepeq6_html_42133b4adaad2eed.png)

 Configurando la red en el virtual**
  Usualmente tenemos el problema al tratar de establecer una comunicacion en red con la maquina
virtual ya que esta usa un patron de IP diferente (10.0.0.X). Crearemos entonces un puente (bridge)
en la conexion para cambiar ese 10.0.0.X por un 0.0.0.0. Al no asignarle una IP el virtual asignara la
configuracion que posea la interfaz eth0 (la que usamos en linux para acceder a internet)
 **![](RackMultipart20200709-4-zepeq6_html_a164d8ef4a26ab3c.png)** Luego de esto bastaria configurar en las propiedades en la configuracion IPv4 cuando iniciemos
windows en la maquina virtual y podremos comunicarnos bajo una IP asignada por eth0.

**Restauracion de la maquina virtual despues del analisis ![](RackMultipart20200709-4-zepeq6_html_dcad78246b669936.png)**

**Analizando malware en virtual**
Ya que contamos con un entorno Windows para correr nuestras herramientas ( y el malware tambien ), tenemos un honeypot que emula
 puertos y servicios vulnerables a spreading, ahora veamos medidas minimas para proteger la red de nuestro virtual.
 En este caso sera un firewall y un sniffer para cubrir el resto de amenazas que traten de conectarse a internet.

![](RackMultipart20200709-4-zepeq6_html_ee79d6510a94d42f.png)

Haremos un recorrido breve por algunos de los procedimientos que podriamos implementar facilmente desde un virtual.

**Detectando empaquetado o proteccion ![](RackMultipart20200709-4-zepeq6_html_f6e3e21cc2849cc0.png)

 Analizando con debugger (OLLY, IDA, etc) ![](RackMultipart20200709-4-zepeq6_html_74a51b36880542eb.png)

 Analizando comportamiento con Sysanalyzer ![](RackMultipart20200709-4-zepeq6_html_bbd914e0ff316435.png)

 Analisis de cambios en el sistema ![](RackMultipart20200709-4-zepeq6_html_b392730a03cb3bfe.png)**
 